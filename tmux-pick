#!/usr/bin/env bash
# Interactive pattern selection with fzf

set -euo pipefail

CURRENT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PATTERN_SELECT="$CURRENT_DIR/bin/pattern_select"

# Cross-platform notification
notify() {
	local message="$1"
	if [[ -n "${TMUX:-}" ]]; then
		tmux display-message "$message"
	else
		echo "$message" >&2
	fi
}

# Get config from environment or tmux option
if [[ -z "${PATTERN_CONFIG:-}" ]]; then
	if [[ -n "${TMUX:-}" ]]; then
		PATTERN_CONFIG=$(tmux show-option -gqv @pick-config)
	fi
fi

# Verify config is set
if [[ -z "${PATTERN_CONFIG:-}" ]]; then
	echo "Error: Config not set. Set @pick-config in tmux.conf" >&2
	exit 1
fi

export PATTERN_CONFIG

# Check dependencies
command -v fzf &>/dev/null || {
	echo "Error: fzf not found" >&2
	exit 1
}
[[ -x "$PATTERN_SELECT" ]] || {
	echo "Error: pattern_select not found at $PATTERN_SELECT" >&2
	exit 1
}

# Capture content
if [[ -n "${TMUX:-}" ]]; then
	content=$(tmux capture-pane -p -J -S -3000)
else
	[[ -p /dev/stdin ]] || {
		echo "Error: Must be run from tmux or with stdin" >&2
		exit 1
	}
	content=$(cat)
fi

# Extract and validate patterns
patterns=$(echo "$content" | "$PATTERN_SELECT" extract) || exit 1
if [[ -z "$patterns" ]] || [[ -z "$(echo "$patterns" | tr -d '[:space:]')" ]]; then
	notify "No patterns found"
	exit 0
fi

# Build fzf options with template formatting
# Input format: value\ttype (tab-delimited)
# Display: [type] value (formatted by fzf), Search: value only
fzf_opts=(
	--prompt='Select pattern: '
	--header='Enter=execute | Esc=cancel'
	--delimiter=$'\t'
	--with-nth='[{2}] {1}'
	--nth='1'
)
selected=$(echo "$patterns" | fzf "${fzf_opts[@]}") || exit 0

# Execute if something was selected
[[ -n "$selected" ]] && "$PATTERN_SELECT" execute "$selected"
